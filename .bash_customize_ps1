#!/bin/bash

# Symboles
export GIT_BRANCH=$'\U000E0A0'

# See: https://www.ditig.com/256-colors-cheat-sheet
declare -A COLORS=(
    [black]="\[\033[1m\033[38;5;240m\]"
    [red]="\[\033[1m\033[38;5;88m\]"
    [green]="\[\033[1m\033[38;5;65m\]"
    [yellow]="\[\033[1m\033[38;5;142m\]"
    [blue]="\[\033[1m\033[38;5;24m\]"
    [magenta]="\[\033[1m\033[38;5;54m\]"
    [cyan]="\[\033[1m\033[38;5;110m\]"
    [white]="\[\033[1m\033[38;5;250m\]"
    [pink]="\[\033[1m\033[38;5;203m\]"
    [orange]="\[\033[1m\033[38;5;209m\]"
)

# Font
export FONT_RESET="\[$(tput sgr0)\]"
export FONT_BOLD="\[$(tput bold)\]"

# https://emojipedia.org
# Some emojis need additional space add the end.
export EMOJI_DESKTOP_COMPUTER=$'\U0001F5A5\U000FE0F '
export EMOJI_CONTAINER=$'\U0001F4E6'
export EMOJI_VM=$'\U0001F5B2\U000FE0 '
export EMOJI_ROOT=$'\U0001F60E'

find_git_branch() {
  local branch
  if branch=$(git rev-parse --abbrev-ref HEAD 2> /dev/null)\
      && [[ -n "$branch" ]]; then
    if [[ "$branch" == "HEAD" ]]; then
      branch='detached*'
    fi
    git_branch=" ${GIT_BRANCH} $branch"
  else
    git_branch=""
  fi
}

find_git_dirty() {
  local status=$(git status --porcelain 2> /dev/null)
  if [[ "$status" != "" ]]; then
    git_dirty='*'
  else
    git_dirty=''
  fi
}

find_git_tag() {
    local tag
    if tag=$(git describe --tags --abbrev=0 2> /dev/null); then
        git_tag="$tag"
    else
        git_tag=""
    fi
}

PROMPT_COMMAND="find_git_branch; find_git_dirty; find_git_tag; $PROMPT_COMMAND"

# Customize PS1 for bash
# arg1 - user color
# arg2 - host color
# arg3 - workspace color
# arg4 - time color
# arg5 - separator color
function custom_ps1() {
    local args=("$@")
    local colors=(u_color m_color w_color t_color s_color)
    local header="${EMOJI_DESKTOP_COMPUTER}"
    local machine="\h"

    for i in "${!colors[@]}"; do
        local color_name="${args[i]}"
        if [[ -n "$color_name" && -n "${COLORS[$color_name]}" ]]; then
            declare -g "${colors[i]}"="${COLORS[$color_name]}"
        fi
    done

    if [ ${CONTAINER_ID+x} ]; then
        header="${EMOJI_CONTAINER}"
        machine="${CONTAINER_ID}"
    elif systemd-detect-virt --vm -q; then
        header=${EMOJI_VM}
    fi
    if [ "$EUID" -eq 0 ]; then
        header="${EMOJI_ROOT}${header}"
    fi
    export PS1="\
$u_color$header \u \
$s_color@$FONT_RESET \
$m_color$machine \
$s_color:$FONT_RESET \
$w_color\w \
\[${COLORS[cyan]}\]\$git_branch\[${COLORS[red]}\]\$git_dirty\[$FONT_RESET\] \
$s_color>$FONT_RESET \
$t_color\T\
\n\
$sep_color$ $FONT_RESET"
}

