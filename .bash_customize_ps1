#!/bin/bash
# bash_cusomize_ps1 - Useful Bash to custom PS1 value.
# Copyright (C) 2025 val4oss <github.widget541@passmail.net>
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program. If not, see <https://www.gnu.org/licenses/>.

# --- Symboles ---
export GIT_BRANCH=$'\U000E0A0'
export ARROW_LEFT=$'\U000E0B2'
export ARROW_RIGHT=$'\U000E0B0'

# --- Colors ---
# See: https://www.ditig.com/256-colors-cheat-sheet
declare -A COLORS=(
    [black]="\[\033[38;5;237m\]"
    [red]="\[\033[38;5;1m\]"
    [green]="\[\033[38;5;65m\]"
    [yellow]="\[\033[38;5;142m\]"
    [blue]="\[\033[38;5;24m\]"
    [magenta]="\[\033[38;5;97m\]"
    [cyan]="\[\033[38;5;110m\]"
    [white]="\[\033[38;5;251m\]"
    [pink]="\[\033[38;5;212m\]"
    [orange]="\[\033[38;5;209m\]"
    [brown]="\[\033[38;5;137m\]"
    [grey]="\[\033[38;5;246m\]"
    [reset]="\[\033[0m\]"
)
declare -A COLORS_BG=(
    [black]="\[\033[48;5;237m\]"
    [red]="\[\033[48;5;1m\]"
    [green]="\[\033[48;5;65m\]"
    [yellow]="\[\033[48;5;142m\]"
    [blue]="\[\033[48;5;24m\]"
    [magenta]="\[\033[48;5;97m\]"
    [cyan]="\[\033[48;5;110m\]"
    [white]="\[\033[48;5;251m\]"
    [pink]="\[\033[48;5;212m\]"
    [orange]="\[\033[48;5;209m\]"
    [brown]="\[\033[48;5;137m\]"
    [grey]="\[\033[48;5;246m\]"
)
declare -A FONTS=(
  [reset]='\[\033[0m\]'
  [bold]='\[\033[1m\]'
  [dim]='\[\033[2m\]'
  [italic]='\[\033[3m\]'
  [underline]='\[\033[4m\]'
  [blink]='\[\033[5m\]'
  [reverse]='\[\033[7m\]'
  [hidden]='\[\033[8m\]'
)

# ---Emoji ---
# https://emojipedia.org
# Some emojis need additional space add the end.
export EMOJI_DESKTOP_COMPUTER=$'\uf108'
export EMOJI_CONTAINER=$'\uf1b2'
export EMOJI_VM=$'\uf233'
export EMOJI_ROOT=$'\uf17c'

# --- git functions ---
find_git_branch() {
  local branch
  if branch=$(git rev-parse --abbrev-ref HEAD 2> /dev/null)\
      && [[ -n "$branch" ]]; then
    if [[ "$branch" == "HEAD" ]]; then
      branch='detached*'
    fi
    git_branch="${GIT_BRANCH} $branch"
  else
    git_branch=""
  fi
}
find_git_dirty() {
  local status=$(git status --porcelain 2> /dev/null)
  if [[ "$status" != "" ]]; then
    git_dirty='*'
  else
    git_dirty=''
  fi
}
find_git_tag() {
    local tag
    if tag=$(git describe --tags --long 2> /dev/null); then
        git_tag="($(echo $tag | sed 's/-g[0-9a-f]\+$//' | sed 's/-/+/'))"
    else
        git_tag=""
    fi
}
PROMPT_COMMAND="find_git_branch; find_git_dirty; find_git_tag; $PROMPT_COMMAND"

# --- Default prompt colors ---
u_color="${COLORS[green]}"
m_color="${COLORS[green]}"
w_color="${COLORS[blue]}"
t_color="${COLORS[yellow]}"
s_color="${COLORS[magenta]}"
header="${EMOJI_DESKTOP_COMPUTER}"
machine="\h"

# Parse argument for Customize PS1
# arg1 - user color
# arg2 - host color
# arg3 - workspace color
# arg4 - time color
# arg5 - separator color
function custom_parse_args() {
    local caller="${FUNCNAME[1]}"
    local args=("$@")
    local colors=(u_color m_color w_color t_color s_color)

    for i in "${!colors[@]}"; do
        local color_name="${args[i]}"
        if [[ -n "$color_name" && -n "${COLORS[$color_name]}" ]]; then
            if [[ "${caller}" == "custom_ps1" ]]; then
                declare -g "${colors[i]}"="${COLORS[$color_name]}"
            elif [[ "${caller}" == "custom_ps1_bg" ]]; then
                local arrows=(u_arrow m_arrow w_arrow t_arrow s_arrow)
                declare -g "${colors[i]}"="${COLORS_BG[$color_name]}"
                declare -g "${arrows[i]}"="${COLORS[$color_name]}${ARROW_RIGHT}"
            fi
        fi
    done

    if [ ${CONTAINER_ID+x} ]; then
        header="${EMOJI_CONTAINER}"
        machine="${CONTAINER_ID}"
    elif systemd-detect-virt --vm -q; then
        header=${EMOJI_VM}
    fi
    if [ "$EUID" -eq 0 ]; then
        header="${EMOJI_ROOT}${header}"
    fi
}

# Customize PS1 for bash
function custom_ps1() {
    custom_parse_args "$@"
    export PS1="\
${FONTS[bold]}$u_color$header \u${COLORS[reset]} \
$s_color@${COLORS[reset]} \
${FONTS[bold]}$m_color$machine${COLORS[reset]} \
$s_color:${COLORS[reset]} \
$w_color\w${COLORS[reset]} \
\[${COLORS[cyan]}\] \$git_branch\$git_tag\
\[${COLORS[red]}\] \$git_dirty\[${COLORS[reset]}\] \
$s_color>${COLORS[reset]} \
$t_color\T${COLORS[reset]}\
\n\
$sep_color$ ${COLORS[reset]}"
}

# Customize PS1 with background for bash
function custom_ps1_bg() {
    local color_fg="\[\033[38;5;231m\]"
    custom_parse_args "$@"
    export PS1="\
${FONTS[bold]}$u_color$color_fg$header \u${COLORS[reset]}\
${FONTS[bold]}$m_color$u_arrow$color_fg $machine${COLORS[reset]}\
$w_color$m_arrow$color_fg \w${COLORS[reset]}\
\[${COLORS_BG[cyan]}$w_arrow$color_fg\] \$git_branch\$git_tag\
\[${COLORS[red]}\] \$git_dirty\[${COLORS[reset]}\]\
$t_color${COLORS[cyan]}${ARROW_RIGHT}$color_fg \T${COLORS[reset]}$t_arrow${COLORS[reset]}\
\n\
$ ${COLORS[reset]}"
}
