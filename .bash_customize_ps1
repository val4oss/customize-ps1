#!/bin/bash

# --- Symboles ---
export GIT_BRANCH=$'\U000E0A0'

# --- Colors ---
# See: https://www.ditig.com/256-colors-cheat-sheet
declare -A COLORS=(
    [black]="\[\033[38;5;240m\]"
    [red]="\[\033[38;5;88m\]"
    [green]="\[\033[38;5;65m\]"
    [yellow]="\[\033[38;5;142m\]"
    [blue]="\[\033[38;5;24m\]"
    [magenta]="\[\033[38;5;54m\]"
    [cyan]="\[\033[38;5;110m\]"
    [white]="\[\033[38;5;250m\]"
    [pink]="\[\033[38;5;203m\]"
    [orange]="\[\033[38;5;209m\]"
    [reset]="\[\033[0m\]"
)
declare -A FONTS=(
  [reset]='\[\033[0m\]'
  [bold]='\[\033[1m\]'
  [dim]='\[\033[2m\]'
  [italic]='\[\033[3m\]'
  [underline]='\[\033[4m\]'
  [blink]='\[\033[5m\]'
  [reverse]='\[\033[7m\]'
  [hidden]='\[\033[8m\]'
)

# ---Emoji ---
# https://emojipedia.org
# Some emojis need additional space add the end.
export EMOJI_DESKTOP_COMPUTER=$'\U0001F5A5\U000FE0F '
export EMOJI_CONTAINER=$'\U0001F4E6'
export EMOJI_VM=$'\U0001F5B2\U000FE0 '
export EMOJI_ROOT=$'\U0001F60E'

# --- git functions ---
find_git_branch() {
  local branch
  if branch=$(git rev-parse --abbrev-ref HEAD 2> /dev/null)\
      && [[ -n "$branch" ]]; then
    if [[ "$branch" == "HEAD" ]]; then
      branch='detached*'
    fi
    git_branch=" ${GIT_BRANCH} $branch"
  else
    git_branch=""
  fi
}
find_git_dirty() {
  local status=$(git status --porcelain 2> /dev/null)
  if [[ "$status" != "" ]]; then
    git_dirty='*'
  else
    git_dirty=''
  fi
}
find_git_tag() {
    local tag
    if tag=$(git describe --tags --abbrev=0 2> /dev/null); then
        git_tag="$tag"
    else
        git_tag=""
    fi
}
PROMPT_COMMAND="find_git_branch; find_git_dirty; find_git_tag; $PROMPT_COMMAND"

# --- Default prompt colors ---
u_color="${COLORS[green]}"
m_color="${COLORS[green]}"
w_color="${COLORS[blue]}"
t_color="${COLORS[yellow]}"
s_color="${COLORS[magenta]}"
header="${EMOJI_DESKTOP_COMPUTER}"
machine="\h"

# Parse argument for Customize PS1
# arg1 - user color
# arg2 - host color
# arg3 - workspace color
# arg4 - time color
# arg5 - separator color
function custom_parse_args() {
    local args=("$@")
    local colors=(u_color m_color w_color t_color s_color)

    for i in "${!colors[@]}"; do
        local color_name="${args[i]}"
        if [[ -n "$color_name" && -n "${COLORS[$color_name]}" ]]; then
            declare -g "${colors[i]}"="${COLORS[$color_name]}"
        fi
    done

    if [ ${CONTAINER_ID+x} ]; then
        header="${EMOJI_CONTAINER}"
        machine="${CONTAINER_ID}"
    elif systemd-detect-virt --vm -q; then
        header=${EMOJI_VM}
    fi
    if [ "$EUID" -eq 0 ]; then
        header="${EMOJI_ROOT}${header}"
    fi
}

# Customize PS1 for bash
function custom_ps1() {
    custom_parse_args "$@"
    export PS1="\
${FONTS[bold]}$u_color$header \u${COLORS[reset]} \
$s_color@${COLORS[reset]} \
${FONTS[bold]}$m_color$machine${COLORS[reset]} \
$s_color:${COLORS[reset]} \
$w_color\w${COLORS[reset]} \
\[${COLORS[cyan]}\]\$git_branch\[${COLORS[red]}\]\$git_dirty\[${COLORS[reset]}\] \
$s_color>${COLORS[reset]} \
$t_color\T${COLORS[reset]}\
\n\
$sep_color$ ${COLORS[reset]}"
}
